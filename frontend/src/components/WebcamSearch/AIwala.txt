import React, { useRef } from 'react';
import { loadFromFiles, Webcam } from '@teachablemachine/image';
// import "../../public/AI_model";

const AISearch = () => {
    const URL = "../../public/AI_model/";

    const webcamRef = useRef(null);
    const labelContainerRef = useRef(null);

    let my_model, webcam, maxPredictions;

    async function init() {
        const model = URL + "model.json";
        console.log("Model ", model);
        const weights = URL + "weights.bin";
        const metadata = URL + "metadata.json";
        my_model = await loadFromFiles(model, weights, metadata);
        console.log("Model ", my_model);
        maxPredictions = my_model.getTotalClasses();

        const flip = true;
        webcam = new Webcam(200, 200, flip);
        await webcam.setup();
        await webcam.play();
        webcamRef.current.appendChild(webcam.canvas);
        window.requestAnimationFrame(loop);

        for (let i = 0; i < maxPredictions; i++) {
            labelContainerRef.current.appendChild(document.createElement("div"));
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await my_model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className +
                ": " +
                prediction[i].probability.toFixed(2);
            labelContainerRef.current.childNodes[i].innerHTML = classPrediction;
        }
    }

    return (
        <div>
            <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
            <button type="button" onClick={init}>Start</button>
            <div ref={webcamRef} id="webcam-container"></div>
            <div ref={labelContainerRef} id="label-container"></div>
        </div>
    );
};

export default AISearch;
